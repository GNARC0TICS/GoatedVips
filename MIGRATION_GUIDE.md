# Migration Guide: V1 → V2\n\n## Overview\n\nThis guide walks you through migrating from the legacy Goombas x Goated VIPs platform to the new secure, scalable v2.0 architecture.\n\n## ⚠️ Critical Security Fixes\n\nThe new version addresses critical security vulnerabilities:\n\n- ✅ **Password hashing** with bcrypt (was: cleartext storage)\n- ✅ **Environment secrets** (was: hardcoded credentials)\n- ✅ **SQL injection prevention** (was: string interpolation)\n- ✅ **Session security** with Redis (was: memory storage)\n- ✅ **Rate limiting** (was: none)\n- ✅ **Input validation** with Zod (was: minimal)\n\n## Architecture Changes\n\n### Before (V1)\n```\n├── server/\n│   ├── routes.ts (1137 lines, mixed concerns)\n│   ├── auth.ts (cleartext passwords)\n│   └── config/api.ts (hardcoded tokens)\n├── db/schema/ (multiple files, no indexes)\n└── client/ (monolithic bundle)\n```\n\n### After (V2)\n```\n├── src/\n│   ├── domain/\n│   │   ├── entities/ (User, Wager, Race)\n│   │   ├── repositories/ (interfaces)\n│   │   └── services/ (business logic)\n│   ├── infrastructure/\n│   │   ├── auth/ (JWT + Redis sessions)\n│   │   ├── cache/ (Redis implementation)\n│   │   ├── database/ (Drizzle repositories)\n│   │   ├── email/ (service abstraction)\n│   │   ├── logging/ (Winston structured)\n│   │   └── monitoring/ (Prometheus metrics)\n│   └── api/\n│       ├── middleware/ (auth, validation, rate limiting)\n│       ├── routes/ (domain-specific)\n│       └── server.ts (API gateway)\n├── db-new/\n│   └── schema.sql (optimized, indexed)\n└── package-new.json (secure dependencies)\n```\n\n## Migration Steps\n\n### 1. Environment Setup\n\n**Create new environment file:**\n```bash\ncp .env .env.backup\ncat > .env.new << EOF\n# Database\nDATABASE_URL=\"postgresql://neondb_owner:your_password@your-host.neon.tech/neondb?sslmode=require\"\n\n# Redis (required for v2.0)\nREDIS_HOST=\"localhost\"\nREDIS_PORT=\"6379\"\nREDIS_PASSWORD=\"your_redis_password\"\n\n# JWT Secrets (generate secure values)\nJWT_SECRET=\"$(openssl rand -hex 64)\"\nJWT_REFRESH_SECRET=\"$(openssl rand -hex 64)\"\n\n# Server\nPORT=\"3000\"\nHOST=\"0.0.0.0\"\nNODE_ENV=\"production\"\n\n# CORS\nCORS_ORIGINS=\"https://yourdomain.com,https://www.yourdomain.com\"\n\n# Logging\nLOG_LEVEL=\"info\"\nEOF\n```\n\n### 2. Database Migration\n\n**⚠️ BACKUP YOUR DATA FIRST**\n```bash\n# Export existing data\npg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql\n\n# Run new schema (this will drop existing tables)\npsql $DATABASE_URL < db-new/schema.sql\n```\n\n**Data Migration Script:**\n```sql\n-- Migrate users (with password hashing)\nINSERT INTO users (\n    id, username, email, password_hash, role, email_verified,\n    goated_id, goated_username, goated_linked, created_at\n)\nSELECT \n    uuid_generate_v4(),\n    username,\n    email,\n    '$2b$12$LQv3c1yqBwcVsvUyqrB0R.L2a9M4KhJhWJgZPvIm3pY8QpOI3aBc2', -- Default hash, users must reset\n    CASE \n        WHEN is_admin THEN 'admin'\n        ELSE 'user'\n    END,\n    email_verified,\n    goated_id,\n    goated_username,\n    goated_account_linked,\n    created_at\nFROM old_users\nWHERE status != 'deleted';\n\n-- Migrate wager stats\nINSERT INTO wager_stats (\n    user_id, goated_id, username,\n    daily_wager, weekly_wager, monthly_wager, all_time_wager,\n    last_sync_at, created_at\n)\nSELECT \n    u.id,\n    ws.goated_id,\n    ws.username,\n    COALESCE(ws.wager_today::decimal, 0),\n    COALESCE(ws.wager_week::decimal, 0),\n    COALESCE(ws.wager_month::decimal, 0),\n    COALESCE(ws.wager_all_time::decimal, 0),\n    ws.updated_at,\n    ws.created_at\nFROM old_wager_stats ws\nJOIN users u ON u.goated_id = ws.goated_id;\n\n-- Update rankings\nSELECT update_wager_rankings('daily');\nSELECT update_wager_rankings('weekly');\nSELECT update_wager_rankings('monthly');\nSELECT update_wager_rankings('all_time');\n```\n\n### 3. Install Dependencies\n\n```bash\n# Install new dependencies\nnpm install --production\n\n# Or use the new package.json\ncp package-new.json package.json\nnpm install\n```\n\n### 4. Build and Deploy\n\n```bash\n# Build the application\nnpm run build\n\n# Start with new architecture\nnpm start\n```\n\n### 5. Redis Setup\n\n**Local Redis:**\n```bash\n# Install Redis\napt-get install redis-server  # Ubuntu/Debian\nbrew install redis             # macOS\n\n# Start Redis\nredis-server\n```\n\n**Cloud Redis (recommended for production):**\n- AWS ElastiCache\n- Google Cloud Memorystore\n- Azure Cache for Redis\n- Upstash (serverless)\n\n### 6. Health Checks\n\n**Verify migration:**\n```bash\n# Check health\ncurl http://localhost:3000/health\n\n# Check API\ncurl http://localhost:3000/api\n\n# Test authentication\ncurl -X POST http://localhost:3000/api/auth/register \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"username\":\"test\",\"email\":\"test@example.com\",\"password\":\"SecurePass123!\"}'\n```\n\n## Security Checklist\n\n- [ ] Generate secure JWT secrets\n- [ ] Set up Redis with authentication\n- [ ] Configure CORS for your domain\n- [ ] Set NODE_ENV=production\n- [ ] Remove hardcoded credentials\n- [ ] Enable HTTPS in production\n- [ ] Set up monitoring/alerting\n- [ ] Configure log rotation\n- [ ] Test backup/restore procedures\n\n## Performance Improvements\n\n### Database\n- ✅ Added comprehensive indexes\n- ✅ Optimized query patterns\n- ✅ Connection pooling\n- ✅ Prepared statements\n\n### Caching\n- ✅ Redis for sessions\n- ✅ API response caching\n- ✅ Query result caching\n- ✅ Rate limiting storage\n\n### Application\n- ✅ Async/await throughout\n- ✅ Request batching\n- ✅ Compression middleware\n- ✅ Memory optimization\n\n## Monitoring\n\n**Metrics endpoint:**\n```\nGET /metrics\n```\n\n**Health endpoint:**\n```\nGET /health\n```\n\n**Available metrics:**\n- HTTP request duration/count\n- Authentication success/failure rates\n- Database query performance\n- Cache hit/miss ratios\n- Memory/CPU usage\n- Active users/sessions\n\n## Breaking Changes\n\n### API Changes\n- **Authentication:** Now uses JWT tokens instead of sessions\n- **Error format:** Standardized error responses\n- **Rate limiting:** All endpoints now rate limited\n- **Validation:** Stricter input validation\n\n### Database Changes\n- **Password storage:** Migrated to bcrypt hashes\n- **Schema:** Completely new optimized schema\n- **Indexes:** Added performance indexes\n- **Constraints:** Added data validation\n\n### Configuration Changes\n- **Environment variables:** New required vars\n- **Redis:** Now required for sessions\n- **Secrets:** Must be generated securely\n\n## Rollback Plan\n\n**If issues arise:**\n\n1. **Stop v2.0 server**\n2. **Restore database backup:**\n   ```bash\n   psql $DATABASE_URL < backup_YYYYMMDD_HHMMSS.sql\n   ```\n3. **Revert to v1.0:**\n   ```bash\n   git checkout v1.0\n   npm install\n   npm start\n   ```\n\n## Support\n\nFor migration issues:\n1. Check logs: `tail -f logs/combined.log`\n2. Verify health: `curl /health`\n3. Check Redis: `redis-cli ping`\n4. Monitor metrics: `curl /metrics`\n\n## Post-Migration Tasks\n\n1. **Notify users** to reset passwords (due to migration to bcrypt)\n2. **Update monitoring dashboards** for new metrics\n3. **Set up log aggregation** (ELK stack, etc.)\n4. **Configure alerts** for critical errors\n5. **Performance testing** with expected load\n6. **Security audit** of new system\n\n---\n\n**🎉 Migration Complete!**\n\nYour platform is now secure, scalable, and ready for growth."